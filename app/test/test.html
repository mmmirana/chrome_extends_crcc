<div id="plugin_pop">
    <div>this is cp_pop</div>
    <div style="display: none;">
        <input type="text" id="cp_pid" value="0" placeholder="上级节点id"/>
        <button onclick="syncYinhuanNodes(0)">向服务器同步隐患节点数据</button>
    </div>
    <div>
        <button onclick="syncYinhuanNodes(0)">同步隐患节点数据</button>
        <button onclick="formatterData()">生成今日提交数据</button>
        <br/>
        <button onclick="submitData()">提交数据</button>
    </div>
</div>
<script>
    let saveTableTimes = 0;//保存提交的次数
    let submitTableTimes = 0;// 上传提交的次数
    let maxTimes = 5;

    let unitArr = [];

    $().ready(function () {
        // 获取单位名称
        let unitArrData = cp_post('${cfg.crccBaseUrl}/crcc/getAllUnit',)
        if (unitArrData && unitArrData.code === 1) {
            unitArr = unitArrData.data;
        } else {
            console.error('插件服务器异常', JSON.stringify(unitArrData));
        }
    });

    /**
     * 将节点同步至本地服务器
     */
    function syncYinhuanNodes(pid) {
        let syncSuccess = 1;// 默认同步成功

        // 获取隐患名称
        let url = "http://aqgl.crcc.cn/safequality/troubledvr.do?reqCode=troubledvrAddTreeInit&troubleSort=000005&opttype=newline";
        let data = {
            node: pid,
            loginuserid: '10426838',
        };
        let childNodes = cp_post(url, data);

        if (childNodes.length > 0) {
            // 上传至本地服务器
            let uploadresult = uploadYinhuanNodes(JSON.stringify(childNodes));

            // 上传成功
            if ((uploadresult.code || 0) === 1) {
                for (let j = 0; j < childNodes.length; j++) {
                    let childNode = childNodes[j];
                    if (childNode.id) {
                        syncSuccess *= syncYinhuanNodes(childNode.id);
                    }
                }
            }
        }
        return syncSuccess;
    }

    /**
     * 上传至服务器
     * @param textJson
     * @returns {SVGElementInstanceList | NodeListOf<Node & ChildNode> | ActiveX.IXMLDOMNodeList}
     */
    function uploadYinhuanNodes(textJson) {
        return cp_post('${cfg.crccBaseUrl}/crcc/updateYinhuanNodes', {textJson: textJson});
    }

    /**
     * 校验并提交数据
     */
    function submitData() {
        let uploadNumberData = cp_post('${cfg.crccBaseUrl}/crcc/getPostItemNumber', {"date": dateutils.format(new Date(), 'yyyy-MM-dd')});
        if ((uploadNumberData.code || 0) === 1) {
            let number = uploadNumberData.data;
            let total = '${cfg.cp_postNumber}' * 1;
            if (number >= total) {
                alert("您今天已经上传了 " + number + "组数据");
            } else {
                // formatterData();
                let remain = total - number;
                console.log('剩余上传', remain, '组');
                remain = 1;// test
                let postdataData = cp_post('${cfg.crccBaseUrl}/crcc/getRandomPostData', {itemNumber: remain});
                if ((postdataData.code || 0) === 1) {
                    let postdataArr = postdataData.data;
                    for (let i = 0; i < postdataArr.length; i++) {
                        // 要遍历提交的数据
                        let postdata = postdataArr[i];
                        let postdataObj = JSON.parse(postdata.data);

                        // 保存
                        submitSaveData(postdataObj, function (batchid) {
                            // 提交数据
                            submitUploadData(postdataObj, batchid);
                        });
                    }
                }
            }
        }
    }

    /**
     * 保存数据
     */
    function submitSaveData(postdataObj, cb) {
        if (saveTableTimes >= maxTimes) {
            console.log('保存次数提交超过上限', maxTimes, '次，请检查后重试！');
            return;
        }

        saveTableTimes++;

        let $img = $(window.frames[0].document).find("#randSaveImg");
        let validateCode = resolveCode($img)
        if (validateCode && validateCode.length === 4) {
            let validateValcodeData = {
                verifycode: validateCode,
                ttype: "1",
                loginuserid:${cfg.cp_guserid},
                data: postdataObj.dirtydata,
            };
            // 1、校验验证码
            let cp_validateReturn = cp_post("http://aqgl.crcc.cn/safequality/troubledvr.do?reqCode=validateEditGridAttacheType", validateValcodeData);
            if (cp_validateReturn && cp_validateReturn.success) {
                let saveTableData = Object.assign(postdataObj, {"verifycode": validateCode});
                // 2、开始保存
                let cp_saveReturn = cp_post("http://aqgl.crcc.cn/safequality/troubledvr.do?reqCode=insertTroubleDatas", saveTableData);
                // 保存成功
                if (cp_saveReturn.success) {
                    console.log("保存数据成功", JSON.stringify(cp_saveReturn));
                    // 重新获取验证码提交数据
                    let batchid = cp_saveReturn.pid;
                    cb(batchid);
                } else {
                    $img.click();
                    setTimeout(function () {
                        submitSaveData(postdataObj, cb);
                    }, 1000);
                }
            } else {
                $img.click();
                setTimeout(function () {
                    submitSaveData(postdataObj, cb);
                }, 1000);
            }
        } else {
            $img.click();
            setTimeout(function () {
                submitSaveData(postdataObj, cb);
            }, 1000);
        }
    }


    /**
     * 提交数据
     */
    function submitUploadData(postdataObj, batchid) {
        if (submitTableTimes >= maxTimes) {
            console.log('提交数据次数提交超过上限', maxTimes, '次，请检查后重试！');
            return;
        }

        submitTableTimes++;

        let $img = $(window.frames[0].document).find("#randSaveImg");
        let validateCode = resolveCode($img);

        if (validateCode && validateCode.length === 4) {
            let validateValcodeData = {
                verifycode: validateCode,
                ttype: "1",
                loginuserid:${cfg.cp_guserid},
                data: []
            };
            // 1、校验验证码
            let cp_validateReturn = cp_post("http://aqgl.crcc.cn/safequality/troubledvr.do?reqCode=validateEditGridAttacheType", validateValcodeData);
            if (cp_validateReturn && cp_validateReturn.success) {
                // # 提交结果
                let submitTableData = {
                    hasCheckPerson: true,
                    userids: "aa",
                    opt: "edit",
                    batchid: batchid,
                    fid: 30623,
                    dirtydata: "[]",
                    unitProject: postdataObj.unitProject,
                    ttype: 1,
                    unitProject: postdataObj.unitProjectName,
                    workTeam: postdataObj.workTeam,
                    wtCheckMan: postdataObj.wtCheckMan,
                    safetyphone: postdataObj.safetyphone,
                    verifycode: resolveCode($img),
                    loginuserid: 10426838,
                };

                // 2、开始提交
                let cp_submitReturn = cp_post("http://aqgl.crcc.cn/safequality/troubledvr.do?reqCode=troubleSubmitExamine", submitTableData);
                // 保存成功
                if (cp_submitReturn && cp_submitReturn.success) {
                    console.log('提交数据成功', JSON.stringify(cp_submitReturn));
                } else {
                    $img.click();
                    setTimeout(function () {
                        submitUploadData(postdataObj, batchid);
                    }, 1000);
                }
            } else {
                $img.click();
                setTimeout(function () {
                    submitUploadData(postdataObj, batchid);
                }, 1000);
            }
        } else {
            $img.click();
            setTimeout(function () {
                submitUploadData(postdataObj, batchid);
            }, 1000);
        }
    }

    /**
     * 整理要提交的数据
     */
    function formatterData() {
        for (let i = 0; i < unitArr.length; i++) {
            if (i === 1) {
                break;
            }
            let unitItem = unitArr[i];
            let unitText = unitItem.text;// 项目名称
            let unitCheckman = unitItem.checkman;// 检查人
            let unitWorkteam = unitItem.workteam;// 劳务公司
            let unitPhone = unitItem.safetyphone;// 手机
            let unitValue = unitItem.value;// unitvalue

            // 共同的参数，最后加入
            let commonData = {
                opt: 'add',
                batchid: '',
                fid: ${cfg.cp_fid},
                unitProject: unitValue,
                unitProjectName: unitText,
                workTeam: unitWorkteam,
                wtCheckMan: unitCheckman,
                safetyphone: unitPhone,
                ttype: 1,
                loginuserid: ${cfg.cp_guserid},
            };

            let dirtyDataTempArr = [];

            let lastNodesData = cp_post("${cfg.crccBaseUrl}/crcc/getLastNodes");
            if ((lastNodesData.code || 0) === 1) {
                let lastNodes = lastNodesData.data;
                for (let k = 0; k < lastNodes.length; k++) {
                    if (k === 10) {
                        break;
                    }
                    // 隐患node节点
                    let lastNode = lastNodes[k];
                    let problemsData = cp_post("${cfg.crccBaseUrl}/crcc/getProblemByNodeid", {nodeid: lastNode.id});
                    if ((problemsData.code || 0) === 1) {
                        let problems = problemsData.data;

                        for (let l = 0; l < problems.length; l++) {
                            // 隐患node 对应的问题
                            let problem = problems[l];
                            let dirtyItem = {
                                unitproject: unitText,
                                workteam: unitWorkteam,
                                wtcheckman: unitCheckman,
                                troublescore: lastNode.score,
                                dangerid: lastNode.id,
                                troublescore: lastNode.score,
                                titledesc: lastNode.danger_name,
                                discoverydate: dateutils.format(new Date(), 'yyyy-MM-dd'),
                                attache_type: 0,
                                rleaf: "0",
                                handleman: unitCheckman,
                                danger_longname: lastNode.danger_longname,
                                danger_longname: lastNode.danger_longname,
                                flgid: dirtyDataTempArr.length + 1,
                                type: 1,
                                danger_level: "2",
                                troublename: problem.problem,
                                remark: problem.problem,
                                peoplecount: getRandom(1, 2),
                                probability: getRandom(1, 2),
                                belongsort: "3",
                                place: "2",
                                fntech: "1",
                                inoutroad: "2",
                                hasworker: "1",
                                solutions: "1",
                                hasresolvent: '${probCfg.solution[getRandom(0, 1)]}',
                                handledate: dateutils.format(new Date(), 'yyyy-MM-dd') + "T00:00:00",
                            }
                            dirtyDataTempArr.push(dirtyItem);

                            if (dirtyDataTempArr.length >= 3 || l === problems.length - 1) {
                                uploadPostDataOnce(commonData, dirtyDataTempArr);
                                dirtyDataTempArr = [];
                            }
                        }
                    }
                }
            }
        }
    }

    /**
     * 分批次上传
     * @param commonData
     * @param dirtyDataTempArr
     */
    function uploadPostDataOnce(commonData, dirtyDataTempArr) {
        commonData.dirtydata = JSON.stringify(dirtyDataTempArr);
        let requestData = {
            postType: 1,
            postUrl: "http://aqgl.crcc.cn/safequality/troubledvr.do?reqCode=insertTroubleDatas",
            postData: JSON.stringify(commonData),
        };
        let result = cp_post('${cfg.crccBaseUrl}/crcc/uploadPostData', requestData);
        console.log(JSON.stringify(result));

        // console.log(validateCode);
        // console.log(JSON.stringify(commonData));
        // console.log(JSON.stringify(dirtyDataTempArr));
    }
</script>